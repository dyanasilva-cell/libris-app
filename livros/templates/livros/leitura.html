{% extends "global/base.html" %}
{% load static %}

{% block title %}Leitura ‚Äî {{ livro.titulo }}{% endblock %}

{% block content %}
<main class="leitura-container">

    <!-- HEADER -->
    <header class="detail-topbar leitura-topbar">
        <a href="{% url 'livros:detalhe_livro' livro.pk %}">
            <span class="icon">‚¨ÖÔ∏è</span>
        </a>

        <div class="top-actions">
            <!-- Download (desativado por enquanto) -->
            <span class="icon" id="download-btn">‚¨áÔ∏è</span>

            <!-- Favoritar -->
            <span class="icon" id="favorite-btn">ü§ç</span>

            <!-- Leitura em voz alta -->
            <span class="icon" id="audio-btn">üîä</span>
        </div>
    </header>

    <!-- CAPA -->
    {% if pagina == 1 %}
    <section class="pagina-box center">
        <img src="{{ livro.capa.url }}" class="capa-leitura">
    </section>
    {% endif %}

    <!-- T√çTULO -->
    {% if pagina == 2 %}
    <section class="pagina-box center">
        <h1 class="titulo-leitura">{{ livro.titulo }}</h1>
        <p class="autor-leitura">por {{ livro.autor }}</p>
    </section>
    {% endif %}

    <!-- CONTE√öDO -->
    {% if pagina > 2 %}
    <section class="pagina-box texto-leitura" id="texto-leitura">
        {% for linha in linhas %}
            <p class="linha" data-pos="{{ forloop.counter0 }}">{{ linha }}</p>
        {% endfor %}
    </section>
    {% endif %}

    <button id="btnToggleComentarios" class="btn-toggle-comments">
        üí¨
    </button>

    <!-- SIDEBAR DE COMENT√ÅRIOS (Inicia oculta) -->
    <aside id="sidebarComentarios" class="comentarios-lateral hidden">
        <div class="sidebar-header">
            <h4>Coment√°rios desta p√°gina</h4>
            <button id="btnFecharSidebar">‚úñ</button>
        </div>

        {% if comentarios_agrupados %}
            {% for pos, lista in comentarios_agrupados.items %}
                <div class="comentario-paragrafo">
                    <span class="p-tag">Trecho {{ pos }}</span>

                    {% for c in lista %}
                        <div class="comment-item">
                            <strong>{{ c.nome }}</strong>
                            <p>{{ c.texto }}</p>
                            <span class="data">{{ c.data|date:"d/m H:i" }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        {% else %}
            <p>üì≠ Nenhum coment√°rio nesta p√°gina.</p>
        {% endif %}
    </aside>

    <!-- PAGINA√á√ÉO -->
    <footer class="paginacao">
        {% for i in paginas %}
            <a href="?pag={{ i }}" class="page-btn {% if pagina == i %}active{% endif %}">
                {{ i }}
            </a>
        {% endfor %}
    </footer>

    <div class="modal fade" id="modalComentario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <form method="POST" action="{% url 'livros:publicar_comentario' livro.pk %}">
                    {% csrf_token %}

                    <!-- Guarda posi√ß√£o do par√°grafo -->
                    <input type="hidden" name="posicao_paragrafo" id="posicao_paragrafo">

                    <div class="modal-header">
                        <h5 class="modal-title">Comentar trecho</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <textarea name="texto" class="form-control" rows="4" placeholder="Digite seu coment√°rio..."></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Enviar</button>
                    </div>
                </form>

            </div>
        </div>
    </div>

    
</main>



<script>
let synth = window.speechSynthesis;
let lendo = false;

document.addEventListener("DOMContentLoaded", () => {
    const textoContainer = document.getElementById("texto-leitura");
    const btnAudio = document.getElementById("audio-btn");

    if (!textoContainer || !btnAudio) return;

    btnAudio.addEventListener("click", () => {

        // Se estiver lendo ‚Üí parar
        if (lendo) {
            synth.cancel();
            lendo = false;
            btnAudio.innerText = "üîä";
            return;
        }

        const texto = textoContainer.innerText.trim();
        if (!texto.length) return;

        let msg = new SpeechSynthesisUtterance(texto);
        msg.lang = "pt-BR";
        msg.rate = 1.1;
        msg.pitch = 1;

        lendo = true;
        btnAudio.innerText = "‚èπÔ∏è";

        msg.onend = () => {
            lendo = false;
            btnAudio.innerText = "üîä";
        };

        synth.speak(msg);
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const paragrafos = document.querySelectorAll(".linha");
    const modalComentario = document.getElementById("modalComentario");
    const inputPosicao = document.getElementById("posicao_paragrafo");

    paragrafos.forEach(p => {
        p.addEventListener("mouseup", () => {
            const texto = window.getSelection().toString().trim();

            if (texto.length > 0) {
                inputPosicao.value = p.dataset.pos;
                const modal = new bootstrap.Modal(modalComentario);
                modal.show();
            }
        });
    });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnToggleComentarios");
    const sidebar = document.getElementById("sidebarComentarios");
    const fechar = document.getElementById("btnFecharSidebar");

    if (btn && sidebar){
        btn.addEventListener("click", () => {
            sidebar.classList.remove("hidden");
        });
    }

    if (fechar){
        fechar.addEventListener("click", () => {
            sidebar.classList.add("hidden");
        });
    }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    if (params.get("audio") === "1") {
        document.getElementById("audio-btn").click();
    }
});
</script>


{% endblock %}
